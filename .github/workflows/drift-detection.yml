name: Drift Detection

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-west-2' }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -detailed-exitcode -no-color > plan.txt
          EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          cat plan.txt
        continue-on-error: true

      - name: Create Drift Issue
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.txt', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Infrastructure Drift Detected',
              body: `## Drift Detection Report
              
              Infrastructure drift was detected on ${new Date().toISOString()}
              
              <details><summary>Terraform Plan Output</summary>
              
              \`\`\`terraform
              ${plan}
              \`\`\`
              
              </details>
              
              ### Next Steps
              1. Review the changes above
              2. Determine if drift is expected or needs correction
              3. Either apply changes to align infrastructure or update Terraform code
              4. Close this issue once resolved
              `,
              labels: ['infrastructure', 'drift-detection', 'needs-review']
            });
            
            console.log(`Created issue #${issue.data.number}`);

      - name: Comment on Success
        if: steps.plan.outputs.exitcode == '0'
        run: echo "✅ No drift detected. Infrastructure matches Terraform state."
